---
import Layout from '../layouts/Layout.astro';
import PublicationItem from '../components/PublicationItem.astro';
import { getCollection } from 'astro:content';

// 获取所有出版物
const allPublications = await getCollection('publications');

// 按发布日期和年份对出版物进行排序
const sortedPublications = allPublications.sort((a, b) => {
  // 如果有具体发布日期，优先按发布日期排序
  if (a.data.publishedDate && b.data.publishedDate) {
    return new Date(b.data.publishedDate).getTime() - new Date(a.data.publishedDate).getTime();
  }
  
  // 如果只有一个有发布日期，有日期的排在前面
  if (a.data.publishedDate && !b.data.publishedDate) return -1;
  if (!a.data.publishedDate && b.data.publishedDate) return 1;
  
  // 都没有发布日期则按年份降序排序
  if (a.data.year !== b.data.year) {
    return b.data.year - a.data.year;
  }
  
  // 同年按标题字母顺序排序
  return a.data.title.localeCompare(b.data.title);
});

// 按年份对出版物进行分组
const pubsByYear = sortedPublications.reduce((acc, pub) => {
  const year = pub.data.year;
  if (!acc[year]) {
    acc[year] = [];
  }
  acc[year].push(pub);
  return acc;
}, {} as Record<number, any[]>);

const years = Object.keys(pubsByYear).map(Number).sort((a, b) => b - a);

// 统计信息
const totalPubs = allPublications.length;
const journalPubs = allPublications.filter(pub => pub.data.type === 'journal').length;
const conferencePubs = allPublications.filter(pub => pub.data.type === 'conference').length;
const recentPubs = allPublications.filter(pub => pub.data.year >= new Date().getFullYear() - 2).length;

// Current Projects 使用两张静态卡片（基于用户提供图片）
const staticProjects = [
  {
    title: 'AI Agent for Human Mobility Generation',
    image: '/LLMABMframework.jpg',
    description: 'AI agents simulate daily travel routines, using LLMs to plan activities, reflect on behavior, and choose destinations and travel modes based on memory and context.',
    keywords: ['LLM', 'ABM']
  },
  {
    title: 'Environmental exposure and perception',
    image: '/baolu.png',
    description: 'Street view imagery data were used to calculate the MRT at each location around the Olympic Sports Center, enabling a refined estimation of heat exposure within the local travel environment.',
    keywords: ['MRT', 'Urban Climate'],
  },
];
---

<Layout title="Research - UMEP Lab">
    <div class="max-w-6xl mx-auto">
        <!-- Page Header -->
        <!--
        <section class="text-center mb-12">
            <h1 class="text-4xl font-serif font-bold mb-4 text-primary">Publications</h1>
            <p class="text-xl text-gray-600 max-w-4xl mx-auto leading-relaxed mb-8">
                Our publications include peer-reviewed journal articles, conference papers, and collaborative works.
            </p>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 max-w-2xl mx-auto">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                    <div class="text-2xl font-bold text-primary">{totalPubs}</div>
                    <div class="text-sm text-gray-600">Total Publications</div>
                </div>
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                    <div class="text-2xl font-bold text-primary">{journalPubs}</div>
                    <div class="text-sm text-gray-600">Journal Articles</div>
                </div>
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                    <div class="text-2xl font-bold text-primary">{conferencePubs}</div>
                    <div class="text-sm text-gray-600">Conference Papers</div>
                </div>
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                    <div class="text-2xl font-bold text-primary">{recentPubs}</div>
                    <div class="text-sm text-gray-600">Recent (2+ years)</div>
                </div>
            </div>
        </section>
            -->

        <!-- Filter Options -->
        <section class="mb-8">
            <div class="flex flex-wrap gap-4 justify-center">
                <button class="filter-btn active view-toggle-btn" data-view="projects">
                    Current Projects
                </button>
                <button class="filter-btn view-toggle-btn" data-view="pubs">
                    Selected Publications
                </button>
            </div>
        </section>

        <!-- Publications by Year -->
        <section id="pubs-view" class="hidden">
            {years.map(year => (
                <div class="year-section mb-12" data-year={year}>
                    <div class="flex items-center mb-6">
                        <h2 class="text-3xl font-serif font-semibold text-primary mr-4">{year}</h2>
                        <div class="flex-1 h-px bg-gradient-to-r from-primary to-transparent"></div>
                        <span class="text-sm text-gray-500 ml-4">
                            {pubsByYear[year].length} publication{pubsByYear[year].length !== 1 ? 's' : ''}
                        </span>
                    </div>
                    
                    <div class="space-y-6">
                        {pubsByYear[year].map(pub => (
                            <div class="publication-item" data-type={pub.data.type}>
                                <PublicationItem
                                    title={pub.data.title}
                                    authors={pub.data.authors}
                                    journal={pub.data.journal}
                                    year={pub.data.year}
                                    publishedDate={pub.data.publishedDate}
                                    volume={pub.data.volume}
                                    pages={pub.data.pages}
                                    type={pub.data.type}
                                    links={{
                                        doi: pub.data.doi,
                                        code: pub.data.code,
                                    }}
                                    abstract={pub.data.abstract}
                                    keywords={pub.data.keywords}
                                />
                            </div>
                        ))}
                    </div>
                </div>
            ))}
        </section>

        <!-- Current Projects View -->
        <section id="projects-view">
            <div class="mb-6">
                <p class="text-gray-700 leading-relaxed">
Our lab develops an AI agent framework that integrates Large Language Models (LLMs), Reinforcement Learning (RL), and Agent-Based Modeling (ABM) to study the complex interactions between human behavior, the built environment, and urban sustainability.
                </p>
            </div>

            <div class="grid gap-8 sm:grid-cols-2 items-stretch">
                {staticProjects.map(project => (
                    <article class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-lg transition-all duration-300 h-full flex flex-col">
                        {project.image && (
                            <div class="aspect-video overflow-hidden">
                                <img src={project.image} alt={project.title} class="w-full h-full object-cover" />
                            </div>
                        )}
                        <div class="p-6 flex-1 flex flex-col">
                            <h3 class="text-xl font-serif font-bold mb-2 text-gray-900">{project.title}</h3>
                            <p class="text-gray-600 mb-4 flex-1">{project.description}</p>
                            {project.keywords && (
                                <div class="flex flex-wrap gap-2">
                                    {project.keywords.slice(0, 5).map(kw => (
                                        <span class="px-2 py-1 text-xs bg-primary/10 text-primary rounded-full">{kw}</span>
                                    ))}
                                </div>
                            )}
                        </div>
                    </article>
                ))}
            </div>
        </section>

        <!-- Empty State -->
        <div id="no-results" class="hidden text-center py-12">
            <div class="text-gray-400 mb-4">
                <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
            </div>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">No publications found</h3>
            <p class="text-gray-500">Try selecting a different filter or check back later.</p>
        </div>
    </div>
</Layout>

<style>
    .filter-btn {
        @apply px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors font-medium;
    }
    
    .filter-btn.active {
        @apply bg-primary text-white border-primary hover:bg-blue-800;
    }
</style>

<script>
    // View toggle functionality
    document.addEventListener('DOMContentLoaded', function() {
        const toggleButtons = document.querySelectorAll('.view-toggle-btn');
        const pubsView = document.getElementById('pubs-view');
        const projectsView = document.getElementById('projects-view');

        toggleButtons.forEach(btn => {
            btn.addEventListener('click', function(this: HTMLButtonElement) {
                const view = this.getAttribute('data-view');

                // Update active state
                toggleButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                if (view === 'projects') {
                    pubsView?.classList.add('hidden');
                    projectsView?.classList.remove('hidden');
                    // Ensure canvas-based components recompute size after becoming visible
                    setTimeout(() => {
                        window.dispatchEvent(new Event('resize'));
                    }, 50);
                } else {
                    projectsView?.classList.add('hidden');
                    pubsView?.classList.remove('hidden');
                }
            });
        });
    });
</script>